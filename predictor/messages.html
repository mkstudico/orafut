<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ORAFUT | Messages</title>
    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --or-light-bg: #f8f9fa;
            --or-white: #ffffff;
            --or-blue: #00a2ff;
            --or-blue-dark: #007acc;
            --or-blue-light: #e6f6ff;
            --or-gold: #d4af37;
            --or-gold-light: #fff8e1;
            --or-text: #333333;
            --or-text-muted: #666666;
            --or-border: #e0e0e0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.08);
            --transition: all 0.25s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--or-light-bg);
            color: var(--or-text);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: var(--or-white);
            padding: 16px;
            border-bottom: 1px solid var(--or-border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-title {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 24px;
            font-weight: 700;
        }

        .new-chat-btn {
            background: var(--or-gold);
            color: #1a1a1a;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Search */
        .search-container {
            padding: 16px;
            background: var(--or-white);
            border-bottom: 1px solid var(--or-border);
        }

        .search-bar {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 48px;
            background: var(--or-light-bg);
            border: 1px solid var(--or-border);
            border-radius: 8px;
            font-size: 16px;
            color: var(--or-text);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--or-text-muted);
            font-size: 18px;
        }

        /* Conversations List */
        .conversations-list {
            flex: 1;
            overflow-y: auto;
            background: var(--or-white);
        }

        .conversation-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--or-border);
            cursor: pointer;
            transition: var(--transition);
        }

        .conversation-item:hover {
            background: var(--or-light-bg);
        }

        .conversation-item.active {
            background: var(--or-gold-light);
            border-left: 3px solid var(--or-gold);
        }

        .conversation-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 12px;
            background: var(--or-light-bg);
        }

        .conversation-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .conversation-name {
            font-weight: 600;
            color: var(--or-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-time {
            font-size: 12px;
            color: var(--or-text-muted);
        }

        .conversation-preview {
            font-size: 14px;
            color: var(--or-text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-badge {
            background: var(--or-blue);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Chat Container */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 140px);
            background: var(--or-white);
            display: none;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--or-border);
            background: var(--or-white);
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--or-text);
            cursor: pointer;
            margin-right: 12px;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 12px;
            background: var(--or-light-bg);
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-user-info {
            flex: 1;
        }

        .chat-user-name {
            font-weight: 600;
            color: var(--or-text);
        }

        .chat-user-status {
            font-size: 12px;
            color: var(--or-text-muted);
        }

        .chat-actions {
            display: flex;
            gap: 12px;
        }

        .chat-action-btn {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--or-text-muted);
            cursor: pointer;
        }

        /* Messages Area */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--or-light-bg);
        }

        .message {
            margin-bottom: 16px;
            max-width: 80%;
        }

        .message.sent {
            margin-left: auto;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .message.received .message-content {
            background: var(--or-white);
            border: 1px solid var(--or-border);
        }

        .message.sent .message-content {
            background: var(--or-gold);
            color: #1a1a1a;
        }

        .message-image {
            max-width: 200px;
            border-radius: 12px;
            margin-top: 4px;
            cursor: pointer;
        }

        .message-time {
            font-size: 11px;
            color: var(--or-text-muted);
            margin-top: 4px;
            text-align: right;
        }

        /* Input Area */
        .input-area {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--or-white);
            border-top: 1px solid var(--or-border);
            gap: 12px;
        }

        .attachment-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--or-text-muted);
            cursor: pointer;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--or-border);
            border-radius: 24px;
            font-size: 16px;
            color: var(--or-text);
            resize: none;
            max-height: 100px;
            font-family: 'Roboto', sans-serif;
        }

        .send-btn {
            background: var(--or-gold);
            color: #1a1a1a;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Image Preview */
        .image-preview {
            display: none;
            padding: 12px 16px;
            background: var(--or-white);
            border-top: 1px solid var(--or-border);
        }

        .image-preview.show {
            display: block;
        }

        .preview-image {
            max-width: 100px;
            border-radius: 8px;
            position: relative;
        }

        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--or-white);
            border: 1px solid var(--or-border);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }

        .empty-state-icon {
            font-size: 64px;
            color: var(--or-text-muted);
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--or-text);
        }

        .empty-state-text {
            color: var(--or-text-muted);
            font-size: 14px;
            line-height: 1.5;
            max-width: 300px;
            margin: 0 auto;
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 162, 255, 0.1);
            border-top: 4px solid var(--or-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--or-white);
            border-top: 1px solid var(--or-border);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--or-text-muted);
            padding: 4px 8px;
            min-width: 60px;
        }

        .nav-item.active {
            color: var(--or-gold);
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .create-btn {
            background: var(--or-gold);
            color: #1a1a1a;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            margin-top: -20px;
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        /* Mobile Layout */
        @media (max-width: 768px) {
            .conversations-list {
                display: block;
            }
            
            .chat-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1000;
            }
            
            .conversations-list.hidden {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- Conversations List -->
    <div class="conversations-list" id="conversationsList">
        <div class="header">
            <div class="header-content">
                <div class="header-title">Messages</div>
                <button class="new-chat-btn" onclick="startNewChat()">
                    <i class="fas fa-plus"></i> New
                </button>
            </div>
        </div>
        
        <div class="search-container">
            <div class="search-bar">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" id="searchInput" 
                       placeholder="Search messages...">
            </div>
        </div>
        
        <div id="conversationsContainer">
            <!-- Conversations will be loaded here -->
        </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <!-- Chat Header -->
        <div class="chat-header">
            <button class="back-btn" onclick="closeChat()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="chat-avatar" id="chatAvatar">
                <i class="fas fa-user" style="font-size: 20px; color: var(--or-text-muted); display: flex; align-items: center; justify-content: center; height: 100%;"></i>
            </div>
            <div class="chat-user-info">
                <div class="chat-user-name" id="chatUserName">Loading...</div>
                <div class="chat-user-status" id="chatUserStatus">Online</div>
            </div>
            <div class="chat-actions">
                <button class="chat-action-btn" onclick="showChatInfo()">
                    <i class="fas fa-info-circle"></i>
                </button>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="messages-area" id="messagesArea">
            <!-- Messages will be loaded here -->
        </div>

        <!-- Image Preview -->
        <div class="image-preview" id="imagePreview">
            <div style="position: relative; display: inline-block;">
                <img id="previewImage" class="preview-image" alt="Preview">
                <button class="remove-image" onclick="removeImage()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <button class="attachment-btn" onclick="attachImage()">
                <i class="fas fa-image"></i>
            </button>
            <textarea class="message-input" id="messageInput" 
                      placeholder="Type a message..." 
                      oninput="adjustTextareaHeight()"
                      onkeydown="handleEnterKey(event)"></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <i class="fas fa-home nav-icon"></i>
            <span class="nav-label">Home</span>
        </a>
        <a href="posts.html" class="nav-item">
            <i class="fas fa-newspaper nav-icon"></i>
            <span class="nav-label">Posts</span>
        </a>
        
        <!-- CREATE Button (Center) -->
        <button class="create-btn" onclick="openCreatePage()">
            <i class="fas fa-plus"></i>
        </button>
        
        <a href="messages.html" class="nav-item active">
            <i class="fas fa-comments nav-icon"></i>
            <span class="nav-label">Messages</span>
        </a>
        <a href="profile.html" class="nav-item">
            <i class="fas fa-user nav-icon"></i>
            <span class="nav-label">Profile</span>
        </a>
    </div>

    <script type="module">
        import { auth, db, IMGBB_KEY } from './firebase-config.js';
        import { 
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { 
            collection, query, where, orderBy, getDocs, 
            addDoc, doc, getDoc, serverTimestamp, onSnapshot
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        // Global variables
        let currentPredictorId = null;
        let currentChatId = null;
        let currentRecipient = null;
        let selectedImage = null;
        let imageUploadsToday = 0;
        let conversations = [];

        // Check authentication
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '../choose.html';
                return;
            }

            try {
                const predDoc = await getDoc(doc(db, 'predictors', user.uid));
                if (!predDoc.exists()) {
                    // Not a predictor, redirect to user dashboard
                    window.location.href = '../user/dashboard.html';
                    return;
                }

                currentPredictorId = user.uid;
                loadConversations();

            } catch (error) {
                console.error('Auth error:', error);
            }
        });

        async function loadConversations() {
            try {
                document.getElementById('loading').classList.add('active');
                
                // Load conversations where predictor is participant
                const conversationsQuery = query(
                    collection(db, 'conversations'),
                    where('participants', 'array-contains', currentPredictorId),
                    orderBy('lastMessageAt', 'desc')
                );
                
                const conversationsSnapshot = await getDocs(conversationsQuery);
                
                conversations = [];
                const container = document.getElementById('conversationsContainer');
                container.innerHTML = '';
                
                if (conversationsSnapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h3 class="empty-state-title">No messages yet</h3>
                            <p class="empty-state-text">
                                Start a conversation with users or other predictors (predictor-to-predictor chat is not allowed).
                            </p>
                            <button class="new-chat-btn" style="margin-top: 16px;" onclick="startNewChat()">
                                <i class="fas fa-plus"></i> Start New Chat
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // Load each conversation
                for (const convDoc of conversationsSnapshot.docs) {
                    const conversation = {
                        id: convDoc.id,
                        ...convDoc.data()
                    };
                    
                    // Get other participant info
                    const otherParticipantId = conversation.participants.find(id => id !== currentPredictorId);
                    if (!otherParticipantId) continue;
                    
                    // Check if other participant is a predictor (predictor-to-predictor not allowed)
                    const otherPredDoc = await getDoc(doc(db, 'predictors', otherParticipantId));
                    if (otherPredDoc.exists()) {
                        // Predictor-to-predictor chat - skip
                        continue;
                    }
                    
                    // Get user info
                    const userDoc = await getDoc(doc(db, 'users', otherParticipantId));
                    if (!userDoc.exists()) continue;
                    
                    const user = userDoc.data();
                    
                    conversation.otherParticipant = {
                        id: otherParticipantId,
                        name: user.name || 'User',
                        photoUrl: user.photoUrl || '',
                        isOnline: user.isOnline || false
                    };
                    
                    conversations.push(conversation);
                    
                    // Create conversation item
                    const conversationItem = createConversationItem(conversation);
                    container.appendChild(conversationItem);
                }
                
                // Set up real-time listener for new messages
                setupConversationsListener();
                
            } catch (error) {
                console.error('Load conversations error:', error);
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        function createConversationItem(conversation) {
            const item = document.createElement('div');
            item.className = 'conversation-item';
            item.dataset.conversationId = conversation.id;
            item.onclick = () => openChat(conversation);
            
            const lastMessageTime = conversation.lastMessageAt?.toDate ? 
                conversation.lastMessageAt.toDate().toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }) : '';
            
            const unreadCount = conversation.unreadCount?.[currentPredictorId] || 0;
            
            item.innerHTML = `
                <div class="conversation-avatar">
                    ${conversation.otherParticipant.photoUrl ? 
                        `<img src="${conversation.otherParticipant.photoUrl}" alt="${conversation.otherParticipant.name}">` :
                        `<i class="fas fa-user" style="font-size: 20px; color: var(--or-text-muted); display: flex; align-items: center; justify-content: center; height: 100%;"></i>`
                    }
                </div>
                <div class="conversation-info">
                    <div class="conversation-header">
                        <div class="conversation-name">${conversation.otherParticipant.name}</div>
                        <div class="conversation-time">${lastMessageTime}</div>
                    </div>
                    <div class="conversation-preview">${conversation.lastMessage || 'Start a conversation'}</div>
                </div>
                ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
            `;
            
            return item;
        }

        function setupConversationsListener() {
            // Listen for conversation updates
            const conversationsQuery = query(
                collection(db, 'conversations'),
                where('participants', 'array-contains', currentPredictorId),
                orderBy('lastMessageAt', 'desc')
            );
            
            onSnapshot(conversationsQuery, (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added' || change.type === 'modified') {
                        const conversation = {
                            id: change.doc.id,
                            ...change.doc.data()
                        };
                        
                        // Check if it's a predictor-to-predictor chat
                        const otherParticipantId = conversation.participants.find(id => id !== currentPredictorId);
                        if (otherParticipantId) {
                            const otherPredDoc = await getDoc(doc(db, 'predictors', otherParticipantId));
                            if (otherPredDoc.exists()) {
                                // Predictor-to-predictor chat - ignore
                                return;
                            }
                        }
                        
                        updateConversationUI(conversation);
                    }
                });
            });
        }

        function updateConversationUI(conversation) {
            // Find existing conversation item
            const existingItem = document.querySelector(`[data-conversation-id="${conversation.id}"]`);
            const container = document.getElementById('conversationsContainer');
            
            if (existingItem) {
                // Update existing item
                existingItem.innerHTML = `
                    <div class="conversation-avatar">
                        ${conversation.otherParticipant?.photoUrl ? 
                            `<img src="${conversation.otherParticipant.photoUrl}" alt="${conversation.otherParticipant.name}">` :
                            `<i class="fas fa-user" style="font-size: 20px; color: var(--or-text-muted); display: flex; align-items: center; justify-content: center; height: 100%;"></i>`
                        }
                    </div>
                    <div class="conversation-info">
                        <div class="conversation-header">
                            <div class="conversation-name">${conversation.otherParticipant?.name || 'User'}</div>
                            <div class="conversation-time">
                                ${conversation.lastMessageAt?.toDate ? 
                                    conversation.lastMessageAt.toDate().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : ''}
                            </div>
                        </div>
                        <div class="conversation-preview">${conversation.lastMessage || ''}</div>
                    </div>
                    ${(conversation.unreadCount?.[currentPredictorId] || 0) > 0 ? 
                        `<div class="unread-badge">${conversation.unreadCount[currentPredictorId]}</div>` : ''}
                `;
                
                // Move to top
                container.prepend(existingItem);
            } else {
                // Add new item
                const item = createConversationItem(conversation);
                container.prepend(item);
            }
        }

        async function openChat(conversation) {
            currentChatId = conversation.id;
            currentRecipient = conversation.otherParticipant;
            
            // Update UI
            document.getElementById('conversationsList').classList.add('hidden');
            document.getElementById('chatContainer').classList.add('active');
            
            // Update chat header
            document.getElementById('chatUserName').textContent = currentRecipient.name;
            document.getElementById('chatUserStatus').textContent = currentRecipient.isOnline ? 'Online' : 'Offline';
            
            const chatAvatar = document.getElementById('chatAvatar');
            chatAvatar.innerHTML = currentRecipient.photoUrl ? 
                `<img src="${currentRecipient.photoUrl}" alt="${currentRecipient.name}">` :
                '<i class="fas fa-user" style="font-size: 20px; color: var(--or-text-muted); display: flex; align-items: center; justify-content: center; height: 100%;"></i>';
            
            // Load messages
            await loadMessages();
            
            // Mark as read
            await markConversationAsRead();
            
            // Set up real-time message listener
            setupMessagesListener();
        }

        function closeChat() {
            document.getElementById('conversationsList').classList.remove('hidden');
            document.getElementById('chatContainer').classList.remove('active');
            currentChatId = null;
            currentRecipient = null;
            
            // Clear messages area
            document.getElementById('messagesArea').innerHTML = '';
        }

        async function loadMessages() {
            try {
                const messagesArea = document.getElementById('messagesArea');
                messagesArea.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--or-text-muted);">Loading messages...</div>';
                
                // Load messages for this conversation
                const messagesQuery = query(
                    collection(db, 'messages'),
                    where('conversationId', '==', currentChatId),
                    orderBy('timestamp', 'asc'),
                    limit(50)
                );
                
                const messagesSnapshot = await getDocs(messagesQuery);
                
                messagesArea.innerHTML = '';
                
                if (messagesSnapshot.empty) {
                    messagesArea.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--or-text-muted);">
                            <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <p>No messages yet. Start the conversation!</p>
                        </div>
                    `;
                    return;
                }
                
                messagesSnapshot.forEach(doc => {
                    const message = {
                        id: doc.id,
                        ...doc.data()
                    };
                    addMessageToUI(message);
                });
                
                scrollToBottom();
                
            } catch (error) {
                console.error('Load messages error:', error);
            }
        }

        function setupMessagesListener() {
            if (!currentChatId) return;
            
            const messagesQuery = query(
                collection(db, 'messages'),
                where('conversationId', '==', currentChatId),
                orderBy('timestamp', 'asc')
            );
            
            onSnapshot(messagesQuery, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const message = {
                            id: change.doc.id,
                            ...change.doc.data()
                        };
                        
                        // Check if message already exists in UI
                        const existingMessage = document.querySelector(`[data-message-id="${message.id}"]`);
                        if (!existingMessage) {
                            addMessageToUI(message);
                            scrollToBottom();
                        }
                    }
                });
            });
        }

        function addMessageToUI(message) {
            const messagesArea = document.getElementById('messagesArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.senderId === currentPredictorId ? 'sent' : 'received'}`;
            messageDiv.dataset.messageId = message.id;
            
            const messageTime = message.timestamp?.toDate ? 
                message.timestamp.toDate().toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }) : 'Just now';
            
            let contentHTML = '';
            
            if (message.type === 'image' && message.imageUrl) {
                contentHTML = `
                    <img src="${message.imageUrl}" class="message-image" onclick="viewImage('${message.imageUrl}')">
                    <div class="message-time">${messageTime}</div>
                `;
            } else {
                contentHTML = `
                    <div class="message-content">${message.text}</div>
                    <div class="message-time">${messageTime}</div>
                `;
            }
            
            messageDiv.innerHTML = contentHTML;
            messagesArea.appendChild(messageDiv);
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text && !selectedImage) return;
            
            try {
                document.getElementById('sendBtn').disabled = true;
                
                let messageData = {
                    conversationId: currentChatId,
                    senderId: currentPredictorId,
                    senderName: 'Predictor', // Will be updated with actual name
                    timestamp: serverTimestamp(),
                    type: 'text',
                    text: text
                };
                
                // Handle image upload if selected
                if (selectedImage) {
                    // Check daily limit (max 5 images per day)
                    if (imageUploadsToday >= 5) {
                        showNotification('Daily image limit reached (5/day)', 'error');
                        return;
                    }
                    
                    // Upload image to ImgBB
                    const formData = new FormData();
                    formData.append('image', selectedImage);
                    
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        messageData.type = 'image';
                        messageData.imageUrl = result.data.url;
                        messageData.text = 'Sent an image';
                        imageUploadsToday++;
                    } else {
                        throw new Error('Image upload failed');
                    }
                }
                
                // Get predictor info for sender name
                const predDoc = await getDoc(doc(db, 'predictors', currentPredictorId));
                if (predDoc.exists()) {
                    const predictor = predDoc.data();
                    messageData.senderName = predictor.name || 'Predictor';
                }
                
                // Save message to Firebase
                await addDoc(collection(db, 'messages'), messageData);
                
                // Update conversation
                await updateConversation(text);
                
                // Clear input and image
                input.value = '';
                input.style.height = 'auto';
                removeImage();
                
                // Enable send button
                document.getElementById('sendBtn').disabled = false;
                
            } catch (error) {
                console.error('Send message error:', error);
                showNotification('Failed to send message', 'error');
                document.getElementById('sendBtn').disabled = false;
            }
        }

        async function updateConversation(lastMessage) {
            try {
                const conversationRef = doc(db, 'conversations', currentChatId);
                
                await updateDoc(conversationRef, {
                    lastMessage: lastMessage,
                    lastMessageAt: serverTimestamp(),
                    [`unreadCount.${currentRecipient.id}`]: (await increment()) // Increment unread count for recipient
                });
                
            } catch (error) {
                console.error('Update conversation error:', error);
                // If conversation doesn't exist, create it
                await createConversation(lastMessage);
            }
        }

        async function createConversation(lastMessage) {
            try {
                await addDoc(collection(db, 'conversations'), {
                    participants: [currentPredictorId, currentRecipient.id],
                    lastMessage: lastMessage,
                    lastMessageAt: serverTimestamp(),
                    unreadCount: {
                        [currentRecipient.id]: 1
                    },
                    createdAt: serverTimestamp()
                });
                
            } catch (error) {
                console.error('Create conversation error:', error);
            }
        }

        async function markConversationAsRead() {
            if (!currentChatId) return;
            
            try {
                const conversationRef = doc(db, 'conversations', currentChatId);
                
                await updateDoc(conversationRef, {
                    [`unreadCount.${currentPredictorId}`]: 0
                });
                
                // Update UI
                const conversationItem = document.querySelector(`[data-conversation-id="${currentChatId}"]`);
                if (conversationItem) {
                    const unreadBadge = conversationItem.querySelector('.unread-badge');
                    if (unreadBadge) {
                        unreadBadge.remove();
                    }
                }
                
            } catch (error) {
                console.error('Mark as read error:', error);
            }
        }

        function startNewChat() {
            // In a real app, this would open a user selection modal
            // For demo, create a new chat with a random user
            showNotification('Select a user to start chatting', 'info');
        }

        function attachImage() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Validate file
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('Image must be less than 5MB', 'error');
                    return;
                }
                
                if (!file.type.startsWith('image/')) {
                    showNotification('Please select an image file', 'error');
                    return;
                }
                
                selectedImage = file;
                
                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('previewImage');
                    preview.src = e.target.result;
                    document.getElementById('imagePreview').classList.add('show');
                };
                reader.readAsDataURL(file);
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }

        function removeImage() {
            selectedImage = null;
            document.getElementById('imagePreview').classList.remove('show');
        }

        function viewImage(url) {
            window.open(url, '_blank');
        }

        function adjustTextareaHeight() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        function handleEnterKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function showChatInfo() {
            showNotification(`Chatting with ${currentRecipient?.name || 'User'}`, 'info');
        }

        function scrollToBottom() {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--or-white);
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 9999;
                border-left: 4px solid ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#00a2ff'};
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Firebase increment function
        function increment() {
            return firebase.firestore.FieldValue.increment(1);
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const items = document.querySelectorAll('.conversation-item');
            
            items.forEach(item => {
                const name = item.querySelector('.conversation-name').textContent.toLowerCase();
                const preview = item.querySelector('.conversation-preview').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || preview.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // Create button handler
        window.openCreatePage = function() {
            window.location.href = 'create.html';
        };
    </script>
</body>
</html>
