<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match View | ORAFUT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --or-bg: #121212; --or-card: #1e1e1e; --or-blue: #007bff; --or-text: #eee; }
        body { background: var(--or-bg); color: var(--or-text); margin: 0; font-family: sans-serif; padding-bottom: 60px; }
        .header { padding: 15px; background: var(--or-card); font-weight: bold; display: flex; align-items: center; gap: 10px; }
        
        /* Video Canvas */
        .video-canvas { width: 100%; height: 220px; background: black; display: flex; justify-content: center; align-items: center; position: relative; }
        .mute-btn { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        
        /* Main Votes */
        .vote-section { padding: 20px; text-align: center; background: var(--or-card); margin-bottom: 10px; }
        .vote-bar-container { display: flex; height: 30px; border-radius: 15px; overflow: hidden; margin: 15px 0; background: #333; cursor: pointer; }
        .vote-bar { display: flex; justify-content: center; align-items: center; font-size: 0.8rem; font-weight: bold; transition: width 0.5s; }
        .bar-home { background: var(--or-blue); } 
        .bar-draw { background: #555; }
        .bar-away { background: #d32f2f; } /* Red for lower % logic handled in JS */

        /* User Voting */
        .user-vote-area { padding: 20px; display: flex; justify-content: space-between; gap: 10px; }
        .u-btn { flex: 1; padding: 15px; background: #333; border: 1px solid #444; color: white; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .u-btn.selected { background: var(--or-blue); border-color: var(--or-blue); }

        /* Chat */
        .chat-window { height: 300px; overflow-y: auto; padding: 15px; background: #151515; }
        .chat-msg { margin-bottom: 10px; font-size: 0.9rem; }
        .chat-input-area { position: fixed; bottom: 0; width: 100%; display: flex; padding: 10px; background: var(--or-card); }
        .chat-input { flex: 1; padding: 10px; border-radius: 20px; border: none; background: #333; color: white; margin-right: 10px; }
    </style>
</head>
<body>

    <div class="header" onclick="history.back()">
        <i class="fas fa-chevron-left"></i> BACK
    </div>

    <div class="video-canvas" id="videoCanvas">
        <div id="streamMsg">Waiting for stream...</div>
        <button class="mute-btn" onclick="toggleMute()"><i class="fas fa-volume-mute"></i></button>
        </div>

    <div class="vote-section">
        <h3>GURU CONSENSUS</h3>
        <div class="vote-bar-container" onclick="location.href='viewvotes.html'">
            <div class="vote-bar bar-home" style="width: 40%">40%</div>
            <div class="vote-bar bar-draw" style="width: 20%">20%</div>
            <div class="vote-bar bar-away" style="width: 40%">40%</div>
        </div>
        <small style="color:#888;">(Click bar for details)</small>
    </div>

    <div style="padding: 15px; text-align: center;">
        <h2 id="matchTitle">Loading...</h2>
        <p id="matchTime" style="color: #aaa;"></p>
        <div id="matchResult" style="font-size: 1.2rem; font-weight: bold; margin-top: 10px; color: var(--or-blue);"></div>
    </div>

    <div class="user-vote-area" id="userVoteArea">
        <button class="u-btn" onclick="userVote('1')">1</button>
        <button class="u-btn" onclick="userVote('X')">X</button>
        <button class="u-btn" onclick="userVote('2')">2</button>
    </div>

    <div class="chat-window" id="chatWindow">
        </div>
    <div style="height: 60px;"></div> <div class="chat-input-area">
        <input type="text" class="chat-input" placeholder="Chat here..." id="chatMsg">
        <button onclick="sendChat()" style="background:var(--or-blue); border:none; width:40px; height:40px; border-radius:50%; color:white;"><i class="fas fa-paper-plane"></i></button>
    </div>

    <script type="module">
        import { db, rtdb, auth } from './firebase-config.js';
        import { doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const urlParams = new URLSearchParams(window.location.search);
        const matchId = urlParams.get('id');

        // Load Match
        async function loadMatch() {
            if(!matchId) return;
            const snap = await getDoc(doc(db, "matches", matchId));
            if(snap.exists()) {
                const data = snap.data();
                document.getElementById('matchTitle').innerText = `${data.homeTeam} vs ${data.awayTeam}`;
                document.getElementById('matchTime').innerText = new Date(data.startTime).toLocaleString();
                if(data.result) document.getElementById('matchResult').innerText = `Result: ${data.result}`;
            }
        }
        loadMatch();

        // Chat
        const chatRef = ref(rtdb, `chats/${matchId}`);
        window.sendChat = () => {
            const msg = document.getElementById('chatMsg').value;
            if(!msg || !auth.currentUser) return;
            push(chatRef, { user: auth.currentUser.email, text: msg, time: Date.now() });
            document.getElementById('chatMsg').value = '';
        };

        onChildAdded(chatRef, (snap) => {
            const val = snap.val();
            const div = document.createElement('div');
            div.className = 'chat-msg';
            div.innerHTML = `<span style="color:#888; font-size:0.7rem;">${val.user.split('@')[0]}:</span> ${val.text}`;
            document.getElementById('chatWindow').appendChild(div);
            // Auto scroll
            document.getElementById('chatWindow').scrollTop = document.getElementById('chatWindow').scrollHeight;
        });

        // Toggle Mute (Simulated)
        window.toggleMute = () => alert("Mute Toggled");
        
        // User Vote
        window.userVote = (choice) => {
            document.querySelectorAll('.u-btn').forEach(b => b.classList.remove('selected'));
            event.target.classList.add('selected');
            // Save vote to Firestore (implied)
        };
    </script>
</body>
</html>
